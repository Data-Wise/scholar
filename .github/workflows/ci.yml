name: Scholar CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  validate:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          test -f .claude-plugin/plugin.json || { echo "Missing plugin.json"; exit 1; }
          test -f README.md || { echo "Missing README.md"; exit 1; }
          test -x scripts/install.sh || { echo "Missing or non-executable install.sh"; exit 1; }
          test -x scripts/uninstall.sh || { echo "Missing or non-executable uninstall.sh"; exit 1; }
          echo "âœ… All required files present"

      - name: Validate plugin.json
        run: |
          # Check if jq is available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

          # Validate JSON syntax
          jq empty .claude-plugin/plugin.json || { echo "âŒ Invalid JSON in plugin.json"; exit 1; }

          # Check plugin name
          PLUGIN_NAME=$(jq -r '.name' .claude-plugin/plugin.json)
          if [[ "$PLUGIN_NAME" != "scholar" ]]; then
            echo "âŒ Plugin name should be 'scholar', got: $PLUGIN_NAME"
            exit 1
          fi

          # Check version exists
          VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
          if [[ -z "$VERSION" || "$VERSION" == "null" ]]; then
            echo "âŒ Plugin version is missing"
            exit 1
          fi

          echo "âœ… plugin.json is valid (name: $PLUGIN_NAME, version: $VERSION)"

      - name: Check directory structure
        run: |
          test -d src/plugin-api/commands || { echo "âŒ Missing src/plugin-api/commands/ directory"; exit 1; }
          test -d src/plugin-api/skills || { echo "âŒ Missing src/plugin-api/skills/ directory"; exit 1; }
          test -d lib || { echo "âŒ Missing lib/ directory"; exit 1; }
          test -d src/core || { echo "âŒ Missing src/core/ directory"; exit 1; }
          test -d src/mcp-server || { echo "âŒ Missing src/mcp-server/ directory"; exit 1; }
          echo "âœ… All required directories present"

      - name: Validate command count
        run: |
          COMMAND_COUNT=$(find src/plugin-api/commands -name "*.md" -type f | wc -l | tr -d ' ')
          if [ "$COMMAND_COUNT" -lt 21 ]; then
            echo "âŒ Expected at least 21 commands (14 research + 7 teaching), found $COMMAND_COUNT"
            exit 1
          fi
          echo "âœ… Found $COMMAND_COUNT command files"

      - name: Check teaching commands
        run: |
          test -f src/plugin-api/commands/teaching/syllabus.md || { echo "âŒ Missing teaching:syllabus command"; exit 1; }
          test -f src/plugin-api/commands/teaching/assignment.md || { echo "âŒ Missing teaching:assignment command"; exit 1; }
          test -f src/plugin-api/commands/teaching/rubric.md || { echo "âŒ Missing teaching:rubric command"; exit 1; }
          test -f src/plugin-api/commands/teaching/slides.md || { echo "âŒ Missing teaching:slides command"; exit 1; }
          test -f src/plugin-api/commands/teaching/quiz.md || { echo "âŒ Missing teaching:quiz command"; exit 1; }
          test -f src/plugin-api/commands/teaching/exam.md || { echo "âŒ Missing teaching:exam command"; exit 1; }
          test -f src/plugin-api/commands/teaching/feedback.md || { echo "âŒ Missing teaching:feedback command"; exit 1; }
          echo "âœ… All 7 teaching commands present"

      - name: Check skills
        run: |
          SKILL_COUNT=$(find src/plugin-api/skills -name "skill.md" -o -name "SKILL.md" -type f 2>/dev/null | wc -l | tr -d ' ')
          if [ "$SKILL_COUNT" -lt 15 ]; then
            echo "âš ï¸  Expected at least 15 skills, found $SKILL_COUNT (acceptable for MVP)"
          fi
          echo "âœ… Found $SKILL_COUNT skill files"

      - name: Check API wrappers
        run: |
          test -f lib/arxiv-api.sh || { echo "âŒ Missing arxiv-api.sh"; exit 1; }
          test -f lib/crossref-api.sh || { echo "âŒ Missing crossref-api.sh"; exit 1; }
          test -f lib/bibtex-utils.sh || { echo "âŒ Missing bibtex-utils.sh"; exit 1; }
          echo "âœ… All API wrapper files present"

      - name: Check for hardcoded paths
        run: |
          HARDCODED_PATHS=0
          if grep -r "/Users/" src/plugin-api/commands lib 2>/dev/null | grep -v "CLAUDE_PLUGIN_ROOT"; then
            echo "âŒ Found hardcoded /Users/ paths"
            HARDCODED_PATHS=1
          fi
          if grep -r "/home/" src/plugin-api/commands lib 2>/dev/null | grep -v "CLAUDE_PLUGIN_ROOT"; then
            echo "âŒ Found hardcoded /home/ paths"
            HARDCODED_PATHS=1
          fi
          if [ $HARDCODED_PATHS -eq 0 ]; then
            echo "âœ… No hardcoded paths found"
          else
            exit 1
          fi

      - name: Run test suite
        run: |
          bash tests/test-plugin-structure.sh

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All CI checks passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“Š Summary:"
          COMMAND_COUNT=$(find src/plugin-api/commands -name "*.md" -type f | wc -l | tr -d ' ')
          SKILL_COUNT=$(find src/plugin-api/skills -name "skill.md" -o -name "SKILL.md" -type f 2>/dev/null | wc -l | tr -d ' ')
          echo "  - Commands: $COMMAND_COUNT"
          echo "  - Skills: $SKILL_COUNT"
          echo "  - API wrappers: 3"
          echo "  - Teaching commands: 7"
          echo "  - Structure: Unified Plugin + MCP architecture"
